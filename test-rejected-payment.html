<!DOCTYPE html>
<html>
<head>
    <title>Teste de Pagamento Recusado - Mercado Pago</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 300px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #009ee3; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #007bb3; }
        .result { margin-top: 20px; padding: 15px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .test-cards { background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
        .test-cards h3 { margin-top: 0; }
        .card-info { margin-bottom: 10px; }
        .card-info strong { color: #dc3545; }
    </style>
</head>
<body>
    <h1>üß™ Teste de Cart√µes Recusados - Mercado Pago</h1>
    
    <div class="test-cards">
        <h3>Cart√µes de Teste para Recusa</h3>
        <div class="card-info">
            <strong>Fundos Insuficientes:</strong> 5031 4332 1540 6365 | CVV: 123 | Nome: OTHE | Status: rejected
        </div>
        <div class="card-info">
            <strong>Recusa Gen√©rica:</strong> 4013 5406 8274 6260 | CVV: 123 | Nome: OTHE | Status: rejected
        </div>
        <div class="card-info">
            <strong>Cart√£o Desabilitado:</strong> 4509 9535 6623 3704 | CVV: 123 | Nome: OTHE | Status: rejected
        </div>
        <div class="card-info">
            <strong>Pendente:</strong> 4009 1757 0100 8020 | CVV: 123 | Nome: CONT | Status: pending
        </div>
    </div>

    <form id="paymentForm">
        <div class="form-group">
            <label>N√∫mero do Cart√£o:</label>
            <input type="text" id="cardNumber" value="5031433215406365" placeholder="5031 4332 1540 6365" maxlength="19">
            <small style="color: #666;">Este cart√£o deve gerar REJEI√á√ÉO por fundos insuficientes</small>
        </div>
        
        <div class="form-group">
            <label>Nome no Cart√£o:</label>
            <input type="text" id="cardholderName" value="OTHE" placeholder="OTHE">
        </div>
        
        <div class="form-group">
            <label>CVV:</label>
            <input type="text" id="securityCode" value="123" placeholder="123" maxlength="4">
        </div>
        
        <div class="form-group">
            <label>M√™s de Expira√ß√£o:</label>
            <select id="expirationMonth">
                <option value="11" selected>11</option>
                <option value="12">12</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Ano de Expira√ß√£o:</label>
            <select id="expirationYear">
                <option value="2030" selected>2030</option>
                <option value="2031">2031</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>CPF:</label>
            <input type="text" id="cpf" value="46435426325" placeholder="46435426325">
        </div>
        
        <div class="form-group">
            <label>Email:</label>
            <input type="email" id="email" value="test@test.com" placeholder="test@test.com">
        </div>
        
        <div class="form-group">
            <label>Nome do Cliente:</label>
            <input type="text" id="customerName" value="Jo√£o Silva" placeholder="Jo√£o Silva">
        </div>
        
        <div class="form-group">
            <label>Valor (R$):</label>
            <input type="number" id="amount" value="23.50" step="0.01" placeholder="23.50">
        </div>
        
        <button type="submit">üß™ Testar Pagamento Recusado</button>
    </form>
    
    <div id="result"></div>

    <script>
        const mp = new MercadoPago('TEST-7c14e81c-a2ab-4ee1-b91c-da31e0487725');

        document.getElementById('paymentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
            const cardholderName = document.getElementById('cardholderName').value;
            const securityCode = document.getElementById('securityCode').value;
            const expirationMonth = document.getElementById('expirationMonth').value;
            const expirationYear = document.getElementById('expirationYear').value;
            const cpf = document.getElementById('cpf').value;
            const email = document.getElementById('email').value;
            const customerName = document.getElementById('customerName').value;
            const amount = parseFloat(document.getElementById('amount').value);
            
            document.getElementById('result').innerHTML = '<div class="result">‚è≥ Processando teste de recusa...</div>';
            
            try {
                console.log('üß™ Testing card rejection with data:', {
                    cardNumber: cardNumber,
                    cardholderName: cardholderName,
                    expirationMonth: expirationMonth,
                    expirationYear: expirationYear,
                    securityCode: securityCode,
                    cpf: cpf
                });
                
                // Create card token
                const tokenResponse = await mp.createCardToken({
                    cardNumber: cardNumber,
                    cardholderName: cardholderName,
                    cardExpirationMonth: expirationMonth,
                    cardExpirationYear: expirationYear,
                    securityCode: securityCode,
                    identificationType: 'CPF',
                    identificationNumber: cpf
                });
                
                console.log('üé´ Card token created:', tokenResponse);
                
                if (tokenResponse.error) {
                    throw new Error('Erro no token: ' + tokenResponse.error.message);
                }
                
                // Detect payment method
                let paymentMethodId = 'visa';
                if (/^5[1-5]/.test(cardNumber) || /^5031/.test(cardNumber)) {
                    paymentMethodId = 'master';
                } else if (/^3[47]/.test(cardNumber)) {
                    paymentMethodId = 'amex';
                } else if (/^5067/.test(cardNumber)) {
                    paymentMethodId = 'elo';
                }
                
                // Generate unique order ID for test
                const orderId = 'TEST-REJECT-' + Date.now();
                
                // Process payment
                const response = await fetch('/api/mercadopago/process-card-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: tokenResponse.id,
                        paymentMethodId,
                        orderId,
                        amount,
                        email,
                        customerName,
                        cpf
                    })
                });
                
                const result = await response.json();
                
                console.log('üí≥ Payment result:', result);
                
                if (result.success) {
                    let statusText = '';
                    let statusClass = '';
                    
                    switch (result.status) {
                        case 'approved':
                            statusText = '‚úÖ APROVADO (Inesperado!)';
                            statusClass = 'success';
                            break;
                        case 'rejected':
                            statusText = '‚ùå REJEITADO (Esperado!)';
                            statusClass = 'error';
                            break;
                        case 'pending':
                            statusText = '‚è≥ PENDENTE';
                            statusClass = 'error';
                            break;
                        default:
                            statusText = '‚ùì STATUS: ' + result.status;
                            statusClass = 'error';
                    }
                    
                    document.getElementById('result').innerHTML = `
                        <div class="result ${statusClass}">
                            <h3>${statusText}</h3>
                            <p><strong>ID do Pagamento:</strong> ${result.paymentId}</p>
                            <p><strong>Order ID:</strong> ${orderId}</p>
                            <p><strong>Mensagem:</strong> ${result.message}</p>
                            <p><strong>Status Mercado Pago:</strong> ${result.status}</p>
                        </div>
                    `;
                } else {
                    document.getElementById('result').innerHTML = `
                        <div class="result error">
                            <h3>‚ùå Erro no Pagamento (Esperado para cart√µes de teste)</h3>
                            <p><strong>Mensagem:</strong> ${result.message}</p>
                            <p><strong>Order ID:</strong> ${orderId}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Test error:', error);
                document.getElementById('result').innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Erro no Teste</h3>
                        <p><strong>Erro:</strong> ${error.message}</p>
                    </div>
                `;
            }
        });
        
        // Format card number input
        document.getElementById('cardNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '');
            let formattedValue = value.replace(/(.{4})/g, '$1 ').trim();
            if (formattedValue.length > 19) {
                formattedValue = formattedValue.substr(0, 19);
            }
            e.target.value = formattedValue;
        });
    </script>
</body>
</html>