<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste IntegraÃ§Ã£o Mercado Pago</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #00a8ff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0096e6; }
        .result { margin-top: 20px; padding: 15px; border-radius: 4px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .qr-code { text-align: center; margin: 20px 0; }
        .qr-code img { max-width: 200px; }
        .pix-code { background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 4px; font-family: monospace; word-break: break-all; }
    </style>
</head>
<body>
    <h1>ðŸ”’ Teste IntegraÃ§Ã£o Mercado Pago</h1>
    
    <div class="form-group">
        <label for="paymentType">Tipo de Pagamento:</label>
        <select id="paymentType">
            <option value="pix">PIX</option>
            <option value="card">CartÃ£o de CrÃ©dito/DÃ©bito</option>
        </select>
    </div>
    
    <div id="cardForm" style="display: none;">
        <h3>Dados do CartÃ£o (Use cartÃµes de teste do Mercado Pago)</h3>
        <div class="form-group">
            <label for="cardNumber">NÃºmero do CartÃ£o:</label>
            <input type="text" id="cardNumber" placeholder="4013 4013 4013 4013" maxlength="19">
        </div>
        <div class="form-group">
            <label for="expiryDate">Data de Validade:</label>
            <input type="text" id="expiryDate" placeholder="11/25" maxlength="5">
        </div>
        <div class="form-group">
            <label for="securityCode">CÃ³digo de SeguranÃ§a:</label>
            <input type="text" id="securityCode" placeholder="123" maxlength="4">
        </div>
        <div class="form-group">
            <label for="cardholderName">Nome no CartÃ£o:</label>
            <input type="text" id="cardholderName" placeholder="JOÃƒO SILVA">
        </div>
    </div>
    
    <div class="form-group">
        <label for="amount">Valor:</label>
        <input type="number" id="amount" value="23.50" step="0.01">
    </div>
    
    <div class="form-group">
        <label for="email">Email:</label>
        <input type="email" id="email" value="test@example.com">
    </div>
    
    <div class="form-group">
        <label for="customerName">Nome:</label>
        <input type="text" id="customerName" value="JoÃ£o Silva">
    </div>
    
    <div class="form-group">
        <label for="cpf">CPF:</label>
        <input type="text" id="cpf" value="11144477735">
    </div>
    
    <button onclick="processPayment()">ðŸš€ Processar Pagamento</button>
    
    <div id="result"></div>

    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <script>
        let mp = null;
        
        // Initialize MercadoPago
        fetch('/api/mercadopago/public-key')
            .then(res => res.json())
            .then(data => {
                mp = new MercadoPago(data.publicKey);
                console.log('MercadoPago initialized');
            });
        
        document.getElementById('paymentType').addEventListener('change', function() {
            const cardForm = document.getElementById('cardForm');
            if (this.value === 'card') {
                cardForm.style.display = 'block';
            } else {
                cardForm.style.display = 'none';
            }
        });
        
        // Format card number
        document.getElementById('cardNumber').addEventListener('input', function() {
            let value = this.value.replace(/\D/g, '');
            value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
            this.value = value;
        });
        
        // Format expiry date
        document.getElementById('expiryDate').addEventListener('input', function() {
            let value = this.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            this.value = value;
        });
        
        async function processPayment() {
            const paymentType = document.getElementById('paymentType').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const email = document.getElementById('email').value;
            const customerName = document.getElementById('customerName').value;
            const cpf = document.getElementById('cpf').value;
            const orderId = 'TEST-' + Date.now();
            
            document.getElementById('result').innerHTML = '<div class="result">Processando...</div>';
            
            try {
                if (paymentType === 'pix') {
                    await processPIXPayment(orderId, amount, email, customerName, cpf);
                } else {
                    await processCardPayment(orderId, amount, email, customerName, cpf);
                }
            } catch (error) {
                showResult('error', 'Erro: ' + error.message);
            }
        }
        
        async function processPIXPayment(orderId, amount, email, customerName, cpf) {
            const response = await fetch('/api/mercadopago/create-pix-payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ orderId, amount, email, customerName, cpf })
            });
            
            const result = await response.json();
            
            if (result.success) {
                let html = '<div class="result success">';
                html += '<h3>âœ… PIX Criado com Sucesso!</h3>';
                html += '<p><strong>ID do Pagamento:</strong> ' + result.paymentId + '</p>';
                
                if (result.qrCodeBase64) {
                    html += '<div class="qr-code">';
                    html += '<h4>QR Code:</h4>';
                    html += '<img src="data:image/png;base64,' + result.qrCodeBase64 + '" alt="QR Code PIX">';
                    html += '</div>';
                }
                
                if (result.qrCode) {
                    html += '<h4>CÃ³digo PIX Copia e Cola:</h4>';
                    html += '<div class="pix-code">' + result.qrCode + '</div>';
                    html += '<button onclick="copyToClipboard(\'' + result.qrCode + '\')">ðŸ“‹ Copiar CÃ³digo</button>';
                }
                
                html += '</div>';
                document.getElementById('result').innerHTML = html;
            } else {
                showResult('error', 'Erro ao criar PIX: ' + result.message);
            }
        }
        
        async function processCardPayment(orderId, amount, email, customerName, cpf) {
            if (!mp) {
                throw new Error('MercadoPago nÃ£o inicializado');
            }
            
            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
            const expiryDate = document.getElementById('expiryDate').value;
            const securityCode = document.getElementById('securityCode').value;
            const cardholderName = document.getElementById('cardholderName').value;
            
            // Create card token
            const cardData = {
                cardNumber,
                cardholderName,
                cardExpirationMonth: expiryDate.split('/')[0],
                cardExpirationYear: '20' + expiryDate.split('/')[1],
                securityCode,
                identificationType: 'CPF',
                identificationNumber: cpf.replace(/\D/g, '')
            };
            
            const tokenResponse = await mp.createCardToken(cardData);
            
            if (tokenResponse.error) {
                throw new Error('Erro no cartÃ£o: ' + tokenResponse.error.message);
            }
            
            // Detect payment method
            let paymentMethodId = 'visa';
            if (/^5[1-5]/.test(cardNumber) || /^5031/.test(cardNumber)) {
                paymentMethodId = 'master';
            } else if (/^3[47]/.test(cardNumber)) {
                paymentMethodId = 'amex';
            } else if (/^5067/.test(cardNumber)) {
                paymentMethodId = 'elo';
            }
            
            // Process payment
            const response = await fetch('/api/mercadopago/process-card-payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    token: tokenResponse.id,
                    paymentMethodId,
                    orderId,
                    amount,
                    email,
                    customerName,
                    cpf
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showResult('success', 'âœ… Pagamento processado! Status: ' + result.status + ' (ID: ' + result.paymentId + ')');
            } else {
                showResult('error', 'Erro no pagamento: ' + result.message);
            }
        }
        
        function showResult(type, message) {
            document.getElementById('result').innerHTML = 
                '<div class="result ' + type + '">' + message + '</div>';
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('CÃ³digo PIX copiado!');
            });
        }
    </script>
</body>
</html>