Investiga√ß√£o e Corre√ß√£o de Vulnerabilidade na Precifica√ß√£o por Zona de CEP
üìç Contexto da Tela
P√°gina: /events/{id}/address (Tela de confirma√ß√£o de endere√ßo)

Fun√ß√£o: Confirmar endere√ßo e calcular valor de entrega

Tipos de precifica√ß√£o dispon√≠veis:

cep_zone ‚Äì calcula o valor com base na zona definida para o CEP

cep_distance ‚Äì calcula o valor com base na dist√¢ncia

üêû Descri√ß√£o do Problema
Existe uma vulnerabilidade cr√≠tica relacionada √† precifica√ß√£o por zona (cep_zone). Em determinadas situa√ß√µes, o sistema permite que o usu√°rio avance sem que a API de precifica√ß√£o por zona seja consultada corretamente, resultando em:

Pedido sem valor de entrega definido

Poss√≠vel bypass da verifica√ß√£o de cobertura de entrega

Queda para fallback (cep_distance) mesmo quando o evento √© cep_zone

üí° Comportamentos suspeitos identificados
Recarregando a p√°gina (F5):

√Äs vezes, a precifica√ß√£o por zona n√£o √© chamada, ou √© chamada tarde demais, e o sistema assume outro m√©todo ou nenhum.

Tempo de carregamento:

Parece haver uma condi√ß√£o de corrida (race condition) ou um delay de execu√ß√£o na chamada da API logo ap√≥s o reload.

Confirma√ß√£o prematura:

O bot√£o de ‚ÄúConfirmar Endere√ßo‚Äù permite o avan√ßo mesmo sem garantir que o c√°lculo de entrega foi feito corretamente.

üß™ Objetivo da tarefa
Investigar e corrigir o bug que permite avan√ßo sem precifica√ß√£o v√°lida por zona.

Impedir completamente o avan√ßo sem que:

O tipo de precifica√ß√£o do evento (cep_zone) seja respeitado.

A resposta da API de zona de CEP tenha sido processada com sucesso.

Evitar fallback incorreto para cep_distance em eventos configurados para cep_zone.

‚úÖ Solu√ß√µes sugeridas
1. Verifica√ß√£o expl√≠cita no bot√£o "Confirmar Endere√ßo"
Ao clicar no bot√£o, antes de continuar, for√ßar uma chamada invis√≠vel √† API de precifica√ß√£o por zona, se o evento for desse tipo.

Fluxo:

plaintext
Copiar
Editar
Se evento.tipo_entrega == 'cep_zone':
    ‚Üí disparar (em background) uma nova chamada da API de precifica√ß√£o por zona
    ‚Üí bloquear temporariamente o bot√£o "Confirmar"
    ‚Üí s√≥ permitir avan√ßo se a resposta for v√°lida e com pre√ßo
    ‚Üí se sem cobertura ou erro ‚Üí exibir mensagem clara e impedir avan√ßo
2. Estado de carregamento obrigat√≥rio
Adicionar um estado global (ou local com debounce) que garanta que a precifica√ß√£o tenha sido carregada com sucesso antes de liberar qualquer a√ß√£o.

Exemplo:

javascript
Copiar
Editar
const [zonePricingStatus, setZonePricingStatus] = useState('idle'); // 'loading' | 'success' | 'error'

useEffect(() => {
  if (event.tipo_entrega === 'cep_zone') {
    setZonePricingStatus('loading');
    fetchZonePricing().then(resp => {
      if (resp.valid) {
        setZonePricingStatus('success');
      } else {
        setZonePricingStatus('error');
      }
    });
  }
}, [address]); // address confirmed or changed

// Desabilitar bot√£o enquanto n√£o estiver "success"
3. Bloqueio da submiss√£o se tipo de entrega for cep_zone e precifica√ß√£o n√£o for v√°lida
No backend (opcional para seguran√ßa total):

Ao receber a confirma√ß√£o de endere√ßo/pedido:

Se evento exige cep_zone, e n√£o h√° pre√ßo vinculado ou zona v√°lida, bloquear cria√ß√£o do pedido.

Seguran√ßa extra contra manipula√ß√£o de frontend.

üõ°Ô∏è Boas pr√°ticas recomendadas
‚úÖ Desabilitar bot√£o de confirma√ß√£o enquanto a API de precifica√ß√£o estiver carregando.

‚úÖ Evitar fallback autom√°tico para cep_distance sem confirma√ß√£o expl√≠cita de que cep_zone falhou.

‚úÖ Adicionar indicador de carregamento (spinner) quando a API estiver sendo consultada ap√≥s atualiza√ß√£o da p√°gina.

‚úÖ Registrar logs em caso de falha silenciosa para ajudar a depurar.

‚úÖ For√ßar nova consulta em caso de reload da p√°gina, garantindo que os dados carregados n√£o estejam em cache ou incompletos.

üìå Resumo do que precisa ser feito
 Garantir que a API de precifica√ß√£o por zona seja chamada e conclu√≠da com sucesso ao entrar ou recarregar a p√°gina

 Impedir que o bot√£o ‚ÄúConfirmar Endere√ßo‚Äù funcione antes disso

 Bloquear avan√ßos sem precifica√ß√£o v√°lida

 Adicionar fallback seguro com aviso ao usu√°rio, e n√£o silenciosamente

 (Opcional) Validar no backend se cep_zone foi realmente respeitado no pedido